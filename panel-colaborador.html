<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Panel del Colaborador</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <link rel="stylesheet" href="vendor/leaflet.css" />
  <link rel="stylesheet" href="css/admin-panel-styles.css">

  <!-- ✅ Favicon -->
  <link rel="icon" type="image/x-icon" href="img/favicon.ico" />
  <link rel="icon" type="image/png" href="img/favicon-16x16.png" sizes="16x16" />
  <link rel="icon" type="image/png" href="img/favicon-32x32.png" sizes="32x32" />
  <link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon"/>
  <link rel="apple-touch-icon" href="img/apple-touch-icon.png" />
  
  


  <style>
    body{background:linear-gradient(180deg,#f3f6f8 0%,#eef2f5 100%)}
    :root{--azul:#1E405A;--turquesa:#1E8A95;--azul-claro:#3B82F6;--blanco:#ffffff;--accent:#FBBF24}
    :root{--action-pickup: linear-gradient(90deg,var(--turquesa),#06b6d4); --action-loading: linear-gradient(90deg,#f97316,#fb923c); --action-deliver: linear-gradient(90deg,#10b981,#34d399); --action-finish: linear-gradient(90deg,#7c3aed,#8b5cf6);} 
    .stat-card{color:#fff}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:0.75rem}
    .table-header{padding:0.75rem 1rem;text-align:left;font-weight:600;color:#374151;background:#f9fafb}
    /* Action buttons */
    .btn-action{display:inline-flex;align-items:center;gap:.5rem;padding:.5rem .75rem;border-radius:.75rem;color:#fff;font-weight:600;border:none;cursor:pointer;box-shadow:0 6px 18px rgba(2,6,23,0.08);transition:transform .08s ease,opacity .12s ease}
    .btn-action:active{transform:translateY(1px)}
    .btn-pickup{background:linear-gradient(90deg,#1E405A,#2D5A7B);color:#fff}
    .btn-loading{background:linear-gradient(90deg,#FBBF24,#FCD34D);color:#1E405A;font-weight:700}
    .btn-deliver{background:linear-gradient(90deg,#7C3AED,#A78BFA);color:#fff}
    .btn-finish{background:linear-gradient(90deg,#10B981,#34D399);color:#fff}
    .btn-retraso{background:linear-gradient(90deg,#F97316,#FB923C);color:#fff}
    /* Map buttons vivid */
    .map-btn-vivid{padding:.5rem .75rem;border-radius:.5rem;font-weight:600;color:#fff;box-shadow:0 6px 14px rgba(2,6,23,0.06)}
    .map-btn-origin{background:linear-gradient(90deg,#06b6d4,#0ea5a6)}
    .map-btn-dest{background:linear-gradient(90deg,#ef4444,#fb7185)}
    .map-btn-route{background:linear-gradient(90deg,#3b82f6,#06b6d4);color:#fff}
    /* Active job card polish */
    #activeJobSection .bg-white{background:linear-gradient(180deg,#ffffff 0%,#f8fafc 100%)}
    /* Palette accent adjustments */
    .accent-text { color: var(--accent); }
    .header-gradient { background: linear-gradient(90deg,var(--azul),var(--turquesa)); }
    #activeJobInfo h4{color:var(--azul)}
      .underline-accent { text-decoration-color: var(--accent); text-decoration-thickness: 2px; text-underline-offset: 3px; }
    @keyframes pulse { 0%, 100% { box-shadow: 0 0 20px rgba(251, 191, 36, 0.6); } 50% { box-shadow: 0 0 30px rgba(251, 191, 36, 0.9); } }
    /* Sidebar refinements */
    aside#sidebar { box-shadow: 0 8px 24px rgba(2,6,23,0.06); border-right: 1px solid rgba(15,23,42,0.04); }
    aside#sidebar .sidebar-header { align-items: center; gap: 0.75rem; }
    aside#sidebar{background:var(--azul)}
    aside#sidebar .sidebar-header{background:var(--azul) !important}
    aside#sidebar nav{background:var(--azul)}
    aside#sidebar nav a.active, aside#sidebar nav a[aria-current="page"] { background: #facc15; color: #0C375D; box-shadow: inset 4px 0 0 rgba(255,255,255,0.06); }
    aside#sidebar nav a { transition: all 0.15s ease; border-radius: 0.5rem; color:#fff }
    aside#sidebar nav a:hover { transform: translateX(4px); background: #facc15; color:#0C375D }
    .sidebar-logo { font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; }
    /* Modal styles */
    #orderModal .card { box-shadow: none; border: 0; }
    #orderModal { opacity: 0; transform: scale(.98); transition: opacity .25s ease, transform .25s ease; }
    #orderModal.open { opacity: 1; transform: scale(1); }
  </style>
</head>
<body class="bg-gray-100">

  <button id="mobileSidebarToggle" class="fixed top-4 left-4 z-40 p-2 rounded-md bg-white shadow-md md:hidden">
    <i data-lucide="menu" class="w-6 h-6 text-gray-800"></i>
  </button>
  <button id="logout-button-mobile" class="fixed top-4 right-4 z-40 p-2 rounded-md bg-white shadow-md md:hidden flex items-center gap-2">
    <i data-lucide="log-out" class="w-5 h-5 text-gray-800"></i>
    <span class="sr-only">Cerrar Sesión</span>
  </button>
  <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>

  <aside id="sidebar" class="fixed top-0 left-0 h-screen w-64 z-30 flex flex-col transition-all duration-300 ease-in-out transform -translate-x-full md:translate-x-0">
    <div class="sidebar-header flex items-center justify-center py-6 px-4" style="background:var(--azul)">
      <div class="sidebar-logo w-12 h-12 rounded-xl flex items-center justify-center text-white font-bold text-lg shadow-lg" style="background:var(--turquesa)">LLO</div>
      <div class="ml-3">
        <h2 class="text-xl font-bold text-white sidebar-text">Colaborador</h2>
        <div id="collabInfo" class="mt-1">
          <div id="collabName" class="accent-text font-semibold text-sm">Usuario</div>
          <div id="collabEmail" class="text-white text-xs opacity-80">email@ejemplo.com</div>
        </div>
      </div>
    </div>

    <div id="roleWarning" class="mb-4 hidden">
      <div class="p-4 rounded-lg bg-yellow-100 text-yellow-800 border border-yellow-200">
        <div class="flex items-center gap-2">
          <i data-lucide="alert-triangle" class="w-5 h-5"></i>
          <span>Tu rol no es colaborador. Acceso limitado.</span>
        </div>
      </div>
    </div>
    <nav class="flex-1 flex flex-col gap-2 py-4 px-4">
      <a href="panel-colaborador.html" class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-gray-50 active"><i data-lucide="user" class="w-5 h-5"></i> <span class="sidebar-text">Mi Panel</span></a>
      <a href="rendimiento.html" class="flex items-center gap-3 px-4 py-3 rounded-lg"><i data-lucide="bar-chart-3" class="w-5 h-5"></i> <span class="sidebar-text">Rendimiento</span></a>
    </nav>
    <div class="sidebar-footer p-4" style="background:var(--azul)">
      <button id="sidebar-toggle" class="w-full flex items-center justify-center gap-3 px-4 py-3 rounded-lg text-sm border">
        <i id="sidebar-toggle-icon" data-lucide="panel-left-close" class="w-5 h-5"></i>
        <span class="sidebar-text font-medium">Colapsar</span>
      </button>
      <button id="logout-button" class="w-full flex items-center justify-center gap-3 px-4 py-3 rounded-lg mt-2 text-sm border">
        <i data-lucide="log-out" class="w-5 h-5"></i>
        <span class="sidebar-text font-medium">Cerrar Sesión</span>
      </button>
    </div>
  </aside>

  <main id="main-content" class="main-content p-8 space-y-8 md:ml-64">

    <div class="card p-4">
      <div class="flex flex-wrap gap-2">
        <button id="tabBtnActive" class="px-4 py-2 rounded-lg bg-blue-600 text-white font-semibold">Trabajo Activo</button>
      </div>
    </div>

    <section id="sectionActive" class="space-y-8">
      <div class="card p-6">
        <h2 class="text-xl font-bold flex items-center gap-3 mb-4" style="color:var(--turquesa)">
          <span class="bg-blue-100 p-2 rounded-lg"><i data-lucide="inbox" class="w-5 h-5 text-blue-600"></i></span>
          Solicitudes Pendientes
        </h2>
        <div id="pendingOrdersContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      </div>

      <div class="card p-6">
        <h2 class="text-xl font-bold flex items-center gap-3 mb-4" style="color:var(--azul)">
          <span class="bg-blue-100 p-2 rounded-lg"><i data-lucide="list-check" class="w-5 h-5 text-blue-600"></i></span>
          Trabajo Activo
        </h2>
        <div id="assignedOrdersWrapper">
          <div id="assignedOrdersContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>
        <div id="activeJobSection" class="mt-8 hidden" role="region" aria-labelledby="active-job-heading">
          <div class="bg-white rounded-2xl shadow-2xl border border-gray-100 overflow-hidden">
          <!-- Header con degradado y estado -->
          <div class="p-6 header-gradient border-b-4" style="border-color: rgba(30,64,90,0.9)">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
              <div class="flex items-center gap-3">
                <div class="p-3 rounded-xl" style="background: rgba(251, 191, 36, 0.2); box-shadow: 0 0 20px rgba(251, 191, 36, 0.6); animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;">
                  <i data-lucide="briefcase" class="w-7 h-7" style="color: #FBBF24; filter: drop-shadow(0 0 8px rgba(251, 191, 36, 0.8)); animation: pulse 2s ease-in-out infinite;"></i>
                </div>
                <div>
                  <h2 id="active-job-heading" class="text-2xl font-bold text-white">Trabajo Activo</h2>
                  <p class="text-blue-100 text-sm">Monitorea tu progreso en tiempo real</p>
                </div>
              </div>
              <div class="flex items-center gap-3">
                <span id="activeJobStatus" class="px-4 py-2 text-xs font-bold rounded-full bg-white text-blue-700 shadow-lg">—</span>
                <button id="cancelActiveJobBtn" type="button" class="p-2 text-white hover:bg-red-500 bg-red-400 rounded-full transition-all transform hover:scale-110 active:scale-95" title="Cancelar trabajo activo" aria-label="Cancelar trabajo activo">
                  <i data-lucide="x-circle" class="w-5 h-5"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- Indicador de Progreso + Botones de Acción -->
          <div class="p-6 bg-gradient-to-b from-gray-50 to-white border-b border-gray-200 space-y-4">
            <div id="activeJobStepper" class="flex flex-wrap items-center gap-2 justify-center sm:justify-start"></div>
            <div id="activeJobActionButtons" class="flex flex-wrap gap-3 justify-center sm:justify-start">
              <!-- Los botones se generan dinámicamente en JS -->
            </div>
          </div>

          <!-- Contenido Principal: Info + Mapa + Evidencia -->
          <div class="p-6 grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- COLUMNA 1: Información de la Orden (2 columnas en desktop) -->
            <div id="activeJobInfo" class="lg:col-span-2 space-y-6">
              
              <!-- Tarjeta: Detalles del Cliente y Colaborador -->
              <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-5 border border-gray-200 shadow-sm">
                <h3 class="text-sm font-bold text-gray-600 uppercase mb-4 flex items-center gap-2">
                  <i data-lucide="user-check" class="w-4 h-4 text-blue-600"></i>
                  Información General
                </h3>
                <div class="space-y-3">
                  <div class="flex items-center justify-between pb-3 border-b border-gray-300">
                    <span class="text-gray-700 font-semibold">ID Orden:</span>
                    <span id="activeJobOrderId" class="text-lg font-bold text-blue-700 underline underline-accent">#—</span>
                  </div>
                  <div class="flex items-center justify-between pb-3 border-b border-gray-300">
                    <span class="text-gray-700 font-semibold">Colaborador:</span>
                    <span id="activeJobCollab" class="text-lg font-bold accent-text underline underline-accent">—</span>
                  </div>
                  <div class="flex items-center justify-between pb-3 border-b border-gray-300">
                    <span class="text-gray-700 font-semibold">Cliente:</span>
                    <span id="activeJobClient" class="text-gray-900 font-semibold">—</span>
                  </div>
                  <div class="flex items-center justify-between">
                    <span class="text-gray-700 font-semibold">Teléfono:</span>
                    <span id="activeJobPhone" class="text-gray-900 font-mono text-sm">—</span>
                  </div>
                </div>
              </div>

              <!-- Tarjeta: Detalles de la Ruta y Servicio -->
              <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl p-5 border border-green-200 shadow-sm">
                <h3 class="text-sm font-bold text-green-700 uppercase mb-4 flex items-center gap-2">
                  <i data-lucide="map-pin" class="w-4 h-4 text-green-600"></i>
                  Ruta y Servicio
                </h3>
                <div class="space-y-3">
                  <div>
                    <p class="text-xs text-green-700 font-semibold mb-1">ORIGEN:</p>
                    <p id="activeJobPickup" class="text-gray-900 font-semibold text-sm">—</p>
                  </div>
                  <div class="flex justify-center py-2">
                    <div class="flex flex-col items-center gap-1">
                      <div class="w-1 h-8 bg-gradient-to-b from-green-500 to-blue-500"></div>
                      <i data-lucide="arrow-down" class="w-5 h-5 text-blue-500"></i>
                      <div class="w-1 h-8 bg-gradient-to-b from-blue-500 to-red-500"></div>
                    </div>
                  </div>
                  <div>
                    <p class="text-xs text-red-700 font-semibold mb-1">DESTINO:</p>
                    <p id="activeJobDelivery" class="text-gray-900 font-semibold text-sm">—</p>
                  </div>
                  <div class="pt-3 border-t border-green-200">
                    <p class="text-xs text-gray-600 font-semibold mb-1">SERVICIO:</p>
                    <p id="activeJobService" class="text-gray-900 font-semibold">—</p>
                  </div>
                  <div>
                    <p class="text-xs text-gray-600 font-semibold mb-1">VEHÍCULO:</p>
                    <p id="activeJobVehicle" class="text-gray-900 font-semibold text-sm">—</p>
                  </div>
                </div>
              </div>

              <!-- Tarjeta: Notas y Observaciones -->
              <div class="bg-gradient-to-br from-amber-50 to-yellow-50 rounded-xl p-5 border border-amber-200 shadow-sm">
                <h3 class="text-sm font-bold text-amber-700 uppercase mb-3 flex items-center gap-2">
                  <i data-lucide="sticky-note" class="w-4 h-4 text-amber-600"></i>
                  Notas y Observaciones
                </h3>
                <p id="activeJobNotes" class="text-gray-800 text-sm leading-relaxed">—</p>
              </div>

              <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-5 border border-gray-200 shadow-sm">
                <h3 class="text-sm font-bold text-gray-700 uppercase mb-3 flex items-center gap-2">
                  <i data-lucide="list" class="w-4 h-4 text-blue-600"></i>
                  Preguntas del Servicio
                </h3>
                <div id="activeJobQuestions" class="space-y-2 text-sm text-gray-800">—</div>
              </div>

            </div>

            <!-- COLUMNA 2: Mapa y Evidencia (1 columna en desktop) -->
            <div class="lg:col-span-1 space-y-6">
              
              <!-- Tarjeta: Mapa Interactivo -->
              <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                <div id="activeJobMap" class="h-64 w-full bg-gradient-to-br from-gray-300 to-gray-400"></div>
                <div class="p-4 space-y-3">
                  <h3 class="text-sm font-bold text-gray-800 flex items-center gap-2">
                    <i data-lucide="navigation" class="w-4 h-4 text-blue-600"></i>
                    Navegación GPS
                  </h3>
                  <div class="grid grid-cols-2 gap-2">
                    <button id="viewOriginBtn" type="button" class="map-btn-vivid map-btn-origin flex items-center justify-center gap-1.5 text-xs font-bold py-2 rounded-lg hover:shadow-lg transform hover:scale-105 active:scale-95 transition-all">
                      <i data-lucide="map-pin" class="w-4 h-4"></i>
                      <span>Origen</span>
                    </button>
                    <button id="viewDestinationBtn" type="button" class="map-btn-vivid map-btn-dest flex items-center justify-center gap-1.5 text-xs font-bold py-2 rounded-lg hover:shadow-lg transform hover:scale-105 active:scale-95 transition-all">
                      <i data-lucide="flag" class="w-4 h-4"></i>
                      <span>Destino</span>
                    </button>
                    <button id="viewRouteBtn" type="button" class="col-span-2 map-btn-vivid map-btn-route flex items-center justify-center gap-1.5 text-xs font-bold py-2 rounded-lg hover:shadow-lg transform hover:scale-105 active:scale-95 transition-all">
                      <i data-lucide="route" class="w-4 h-4"></i>
                      <span>Ver Ruta Completa</span>
                    </button>
                  </div>
                </div>
              </div>

              <!-- Tarjeta: Evidencia Fotográfica -->
              <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                <div class="p-4 bg-gradient-to-r from-purple-50 to-pink-50 border-b border-purple-200">
                  <h3 class="text-sm font-bold text-purple-800 flex items-center gap-2">
                    <i data-lucide="camera" class="w-4 h-4 text-purple-600"></i>
                    Evidencia Fotográfica
                  </h3>
                </div>
                <div class="p-4 space-y-3">
                  <div class="grid grid-cols-3 gap-2" id="photoGallery"></div>
                  <label for="photoUpload" class="w-full text-center cursor-pointer bg-gradient-to-r from-purple-100 to-pink-100 hover:from-purple-200 hover:to-pink-200 text-purple-800 font-semibold py-3 px-4 rounded-lg border-2 border-dashed border-purple-300 hover:border-purple-400 flex items-center justify-center gap-2 transition-all transform hover:scale-105 active:scale-95">
                    <i data-lucide="plus-circle" class="w-5 h-5"></i>
                    <span>Añadir Foto</span>
                  </label>
                  <input type="file" id="photoUpload" class="hidden" accept="image/*" capture="environment" multiple>
                  <div id="uploadProgress" class="hidden space-y-2">
                    <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                      <div id="evidenceProgressBar" class="bg-gradient-to-r from-purple-500 to-pink-500 h-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <p id="evidenceProgressText" class="text-xs text-center text-gray-600 font-semibold">0%</p>
                  </div>
                </div>
              </div>

            </div>

          </div>
        </div>
        </div>
      </div>
    </section>

    
  </main>

  <!-- Order Details Modal -->
  <div id="orderModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl w-full max-w-2xl overflow-hidden">
      <div class="flex items-center justify-between p-4 border-b">
        <h3 id="orderModalTitle" class="font-bold text-lg">Detalle de la Orden</h3>
        <button id="orderModalClose" class="p-2 rounded hover:bg-gray-100"><i data-lucide="x" class="w-5 h-5"></i></button>
      </div>
      <div id="orderModalBody" class="p-4 text-sm text-gray-700"></div>
      <div class="p-4 border-t flex justify-end gap-2">
        <button id="orderModalAssign" class="px-4 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-sm">Asignar a mí</button>
        <button id="orderModalStart" class="px-4 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 text-sm">Iniciar</button>
      </div>
    </div>
  </div>

  <div id="acceptModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl w-full max-w-xl overflow-hidden">
      <div class="flex items-center justify-between p-4 border-b">
        <h3 class="font-bold text-lg">Confirmar aceptación</h3>
        <button id="acceptModalClose" class="p-2 rounded hover:bg-gray-100"><i data-lucide="x" class="w-5 h-5"></i></button>
      </div>
      <div id="acceptModalBody" class="p-4 text-sm text-gray-700"></div>
      <div class="p-4 border-t flex justify-end gap-2">
        <button id="acceptCancelBtn" class="px-4 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-sm">Cancelar</button>
        <button id="acceptConfirmBtn" class="px-4 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 text-sm">Aceptar</button>
      </div>
    </div>
  </div>

  <div id="customerCommentModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl w-full max-w-xl overflow-hidden">
      <div class="flex items-center justify-between p-4 border-b">
        <h3 class="font-bold text-lg">Comentario del Cliente</h3>
        <button id="closeCustomerComment" class="p-2 rounded hover:bg-gray-100"><i data-lucide="x" class="w-5 h-5"></i></button>
      </div>
      <div id="customerCommentBody" class="p-4 text-sm text-gray-700 max-h-[65vh] overflow-y-auto"></div>
    </div>
  </div>

  <script src="vendor/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/supabase-config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="js/notifications.js"></script>
  <script src="js/sidebar.js"></script>
  <script src="js/order-manager.js"></script>
  <script src="js/panel-colaborador.js"></script>
  <script>if(window.lucide&&lucide.createIcons){lucide.createIcons();}</script>
</body>
</html>
